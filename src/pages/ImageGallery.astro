---
import IndexLayout from '../layouts/IndexLayout.astro';
import fs from 'fs';
import path from 'path';
import ExifReader from 'exifreader';
import sharp from 'sharp';

const BASE_URL = import.meta.env.BASE_URL || '/SeanBlog'; // 使用环境变量或默认值

async function getImagesFromDirectory(dir) {
  // console.log(`扫描目录: ${dir}`);
  const files = fs.readdirSync(dir);
  // console.log(`找到文件: ${files.join(', ')}`);
  
  const imagePromises = files
    .filter(file => ['.jpg', '.jpeg', '.png', '.gif', '.webp'].includes(path.extname(file).toLowerCase()))
    .map(async (file, index) => {
      const filePath = path.join(dir, file);
      // console.log(`处理文件: ${filePath}`);
      try {
        const buffer = fs.readFileSync(filePath);
        let metadata;
        
        if (path.extname(file).toLowerCase() === '.webp') {
          const image = sharp(buffer);
          metadata = await image.metadata();
        } else {
          metadata = ExifReader.load(buffer);
        }
        
        return {
          id: index + 1,
          src: `${BASE_URL}${path.join(dir, file).replace('public', '').replace(/\\/g, '/')}`,
          alt: path.parse(file).name,
          title: path.parse(file).name.replace(/([A-Z])/g, ' $1').trim(),
          metadata: {
            dateTime: metadata.DateTime ? metadata.DateTime.description : (metadata.exif ? metadata.exif.DateTimeOriginal : 'Unknown'),
            make: metadata.Make ? metadata.Make.description : (metadata.exif ? metadata.exif.Make : 'Unknown'),
            model: metadata.Model ? metadata.Model.description : (metadata.exif ? metadata.exif.Model : 'Unknown'),
          }
        };
      } catch (error) {
        console.error(`处理文件 ${filePath} 时出错:`, error);
        return null;
      }
    });

  const images = await Promise.all(imagePromises);
  return images.filter(image => image !== null);
}
 
const baseDir = 'public/pictures/Albums';
console.log(`Base directory: ${baseDir}`);

const albumsPromise = Promise.all(
  fs.readdirSync(baseDir)
    .filter(file => fs.statSync(path.join(baseDir, file)).isDirectory())
    .map(async (albumName) => {
      console.log(`处理相册: ${albumName}`);
      const albumPath = path.join(baseDir, albumName);
      const images = await getImagesFromDirectory(albumPath);
      console.log(`在 ${albumName} 中找到 ${images.length} 张图片`);
      return {
        id: albumName.toLowerCase(),
        name: albumName.replace(/([A-Z])/g, ' $1').trim(),
        path: albumPath,
        images: images
      };
    })
);

const albums = await albumsPromise;
console.log(`总共相册数: ${albums.length}`);
---

<IndexLayout title="ImageGallery">
  <div slot="maindiv" class="album-gallery">
    <h1>我的相册集</h1>
    
    <div class="album-tabs">
      {albums.map((album) => (
        <button class="album-tab" data-album={album.id}>{album.name}</button>
      ))}
    </div>

    {albums.map((album) => (
      <div class="album" id={album.id}>
        <h2>{album.name}</h2>
        <div class="image-grid">
          {album.images.length > 0 ? (
            album.images.map((image) => (
              <div class="image-item" key={image.id}>
                <div class="image-container">
                  <img src={image.src} alt={image.alt} loading="lazy" data-image-id={image.id} />
                  <div class="image-overlay">
                    <div class="image-title">{image.title}</div>
                    <div class="image-metadata">
                      <p>{image.metadata.dateTime}</p>
                      <p>{image.metadata.make} {image.metadata.model}</p>
                    </div>
                  </div>
                </div>
              </div>
            ))
          ) : (
            <p>这个相册中没有图片。</p>
          )}
        </div>
      </div>
    ))}

    <div id="modal" class="modal">
      <span class="close">&times;</span>
      <img class="modal-content" id="modal-image" />
      <div id="caption"></div>
    </div>
  </div>
</IndexLayout>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap');

  .album-gallery {
    padding: 20px;
    max-width: 1200px;
    margin: 0 auto;
    font-family: 'Roboto', sans-serif;
  }

  .album-tabs {
    display: flex;
    justify-content: center;
    margin-bottom: 20px;
  }

  .album-tab {
    padding: 10px 20px;
    margin: 0 5px;
    border: none;
    background-color: #f0f0f0;
    cursor: pointer;
    transition: background-color 0.3s;
  }

  .album-tab:hover, .album-tab.active {
    background-color: #ddd;
  }

  .album {
    display: none;
  }

  .album.active {
    display: block;
  }

  .image-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 20px;
  }

  .image-item {
    position: relative;
    overflow: hidden;
    border-radius: 4px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  .image-container {
    width: 100%;
    padding-top: 100%; /* 1:1 Aspect Ratio */
    position: relative;
  }

  .image-container img {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .image-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background-color: rgba(0,0,0,0.7);
    color: white;
    padding: 10px;
    transform: translateY(100%);
    transition: transform 0.3s ease-in-out;
  }

  .image-item:hover .image-overlay {
    transform: translateY(0);
  }

  .image-title {
    font-size: 14px;
    font-weight: bold;
    margin-bottom: 5px;
  }

  .image-metadata {
    font-size: 12px;
  }

  .image-metadata p {
    margin: 0;
  }

  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.9);
    overflow: auto;
  }

  .modal-content {
    margin: auto;
    display: block;
    width: auto;
    height: auto;
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  }

  .close {
    position: absolute;
    top: 15px;
    right: 35px;
    color: #f1f1f1;
    font-size: 40px;
    font-weight: bold;
    cursor: pointer;
    z-index: 1001;
  }

  #caption {
    margin: auto;
    display: block;
    width: 80%;
    max-width: 700px;
    text-align: center;
    color: #ccc;
    padding: 10px 0;
    height: 150px;
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
  }
</style>

<script>
  const modal = document.getElementById('modal');
  const modalImg = document.getElementById('modal-image');
  const captionText = document.getElementById('caption');
  const closeBtn = document.getElementsByClassName('close')[0];
  const imageElements = document.querySelectorAll('.image-item img');

  imageElements.forEach(img => {
    img.onclick = function() {
      modal.style.display = "block";
      modalImg.src = this.src;
      captionText.innerHTML = this.alt;
      
      // 禁止页面滚动
      document.body.style.overflow = 'hidden';
    }
  });

  closeBtn.onclick = function() {
    modal.style.display = "none";
    // 恢复页面滚动
    document.body.style.overflow = 'auto';
  }

  window.onclick = function(event) {
    if (event.target == modal) {
      modal.style.display = "none";
      // 恢复页面滚动
      document.body.style.overflow = 'auto';
    }
  }

  // 添加键盘事件监听器
  document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape' && modal.style.display === 'block') {
      modal.style.display = "none";
      // 恢复页面滚动
      document.body.style.overflow = 'auto';
    }
  });

  // 添加标签切换功能
  const albumTabs = document.querySelectorAll('.album-tab');
  const albums = document.querySelectorAll('.album');

  albumTabs.forEach(tab => {
    tab.addEventListener('click', () => {
      const albumId = tab.getAttribute('data-album');
      
      albumTabs.forEach(t => t.classList.remove('active'));
      albums.forEach(a => a.classList.remove('active'));

      tab.classList.add('active');
      document.getElementById(albumId).classList.add('active');
    });
  });

  // 默认显示第一个相册
  albumTabs[0].click();
</script>
