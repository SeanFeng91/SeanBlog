---
import IndexLayout from "../../layouts/IndexLayout.astro";
import { query } from "../../lib/database.js";

// 获取过去一个月内的所有新闻
const news = query(`
  SELECT id, headline, publication_date, content, summary
  FROM news_teasers
  WHERE summary IS NOT NULL
  ORDER BY publication_date DESC
  LIMIT 100
`);

const pageTitle = "今日资讯";

function formatDateTime(dateString) {
  if (!dateString) return '日期未知';
  try {
    const [datePart, timePart] = dateString.split(' ');
    if (!datePart) return dateString;
    const [year, month, day] = datePart.split(/年|月/);
    return `${year}年${month}月${day.replace('号', '')}日 ${timePart || ''}`.trim();
  } catch (error) {
    console.error('Error formatting date:', error);
    return dateString;
  }
}
---

<IndexLayout pageTitle={pageTitle}>
  <div slot="maindiv">
    <h1 class="text-3xl font-bold mb-6">今日资讯</h1>
    
    <div class="news-container">
      {news.map((item) => (
        <div class="news-item mb-4 p-4 bg-white dark:bg-gray-800 rounded-lg shadow-md" data-id={item.id}>
          <h2 class="text-xl font-semibold mb-2">{item.headline}</h2>
          <p class="text-sm text-gray-500 mb-2">
            {item.publication_date ? formatDateTime(item.publication_date) : '日期未知'}
          </p>
          <p class="summary cursor-pointer">{item.summary}</p>
          <div class="full-content hidden">
            <p>{item.content}</p>
          </div>
        </div>
      ))}
    </div>
  </div>
</IndexLayout>

<script is:inline>
  // 点击摘要显示全文
  document.querySelectorAll('.summary').forEach(summary => {
    summary.addEventListener('click', () => {
      const fullContent = summary.nextElementSibling;
      fullContent.classList.toggle('hidden');
    });
  });

  // 格式化所有日期显示
  document.querySelectorAll('.news-item p:nth-child(2)').forEach(dateElement => {
    const originalDate = dateElement.textContent.trim();
    dateElement.textContent = formatDateTimeClient(originalDate);
  });

  function formatDateTimeClient(dateString) {
    if (!dateString) return '日期未知';
    try {
      const [datePart, timePart] = dateString.split(' ');
      if (!datePart) return dateString;
      const [year, month, day] = datePart.split(/年|月/);
      return `${year}年${month}月${day.replace('号', '')}日 ${timePart || ''}`.trim();
    } catch (error) {
      console.error('Error formatting date:', error);
      return dateString;
    }
  }
</script>

<style>
  .hidden {
    display: none;
  }
</style>
